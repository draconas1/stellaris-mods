# condan_events.txt  Contingency Processing Core 1A6F
# Stellaris 2024 ModJam
# Contributors: Draconas

namespace = condan_events

country_event = {
    id = condan_events.001
    title = condan_events.001.title
    desc = condan_events.001.desc
    picture = GFX_evt_ancient_databank
    is_triggered_only = yes

    trigger = {
        condan_trigger = yes
    }

    option = {
        name = condan_events.001.spiritualists
        country_event = { id = condan_comms.050 }
    }

    option = {
        name = condan_events.001.xenophiles
        country_event = { id = condan_comms.060 }
    }

    option = {
        name = condan_events.001.armies
        country_event = { id = condan_comms.070 }
    }

    option = {
        name = condan_events.001.fleets
        country_event = { id = condan_comms.080 }
    }
}


# repair planet
planet_event = {
    id = condan_events.010
    title = condan_events.010.title
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = { has_modifier = condan_leader_trapped}
            remove_modifier = condan_leader_trapped
            owner = {
                country_event = { id = condan_comms.020 }
            }
        }
        else = {
            planet_event = { id = condan_events.020 }
        }
    }
}

# No Condan
planet_event = {
    id = condan_events.020
    title = condan_events.020.title
    desc = condan_events.020.desc
    picture = GFX_evt_ancient_databank
    is_triggered_only = yes

    option = {
        name = OK
    }
}

# convert a regular empire into determined exterminator
country_event = {
    id = condan_events.030
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        # set this to ensure that personality sets properly
        set_country_flag = condan_terminator

        # determine average councillor level for setting our nodes later
        set_variable = { which = council_level value = 0 }
        every_owned_leader = {
            limit = {
                is_councilor = yes
                is_ruler = no
            }
            export_trigger_value_to_variable = { variable = leader_skill trigger = has_skill}
            ROOT = {
                change_variable = { which = council_level value = prev.leader_skill}
            }
        }
        divide_variable  = { which = council_level value  = 4 }
        ceiling_variable = council_level

        #explictily get our current leaders out of the council
        unlock_council_selection = yes

        # there are terminator compatible origins, but there also a load of very not terminator compat ones
        # so resetting to default
        set_origin = origin_default

        clear_ethos = yes
        # tried shift ethic, but that didn't work out and left with 1 ethic remaining and that went VERY wrong
        country_add_ethic = ethic_gestalt_consciousness
        change_government = {
            authority = auth_machine_intelligence
            civics = {
                civic = civic_machine_terminator
                civic = civic_machine_warbots
            }
            cooldown = no
            remove_invalid_civics = yes
        }
        reset_policy_cooldowns = yes

        # We are now a machine empire not a synthetic one
        remove_country_flag = synthetic_empire
        remove_country_flag = synth_assimilation

        # hive mind everyone
        ROOT.species = {
            create_species = {
                adjective = this
                name = this
                class = "ROBOT"
                namelist = "AI"
                portrait = "hum_robot_red"
                homeworld = ROOT.capital_scope
                traits = { trait = "trait_machine_unit" }
                effect = { save_event_target_as = target_species }
            }
        }
        change_dominant_species = { species = event_target:target_species change_all = yes }
        #every_owned_pop = { change_species = event_target:target_species }

        # ensure that our new species has the correct rights.
        event_target:target_species = {
            set_citizenship_type = { country = root type = citizenship_full_machine cooldown = no }
            set_living_standard = { country = root type = living_standard_hive_mind cooldown = no }
            set_military_service_type = { country = root type = military_service_full cooldown = no }
        }

        # ensure that everyone else (in theory nothing, as we just turned everyone into machines, buuuuut...) has the correct rights: exterminate
        every_owned_species = {
            limit = { NOT = { is_same_value = event_target:target_species } }
            set_citizenship_type = { country = root type = citizenship_purge_machine cooldown = no }
            set_living_standard = { country = root type = living_standard_none cooldown = no }
            set_purge_type = {  country = root type = purge_normal cooldown = no}
        }

        # flip our leaders.
        every_owned_leader = {
            limit = {
                NOR = {
                    is_councilor = yes
                    is_event_leader = yes
                    has_leader_flag = renowned_leader
                    has_leader_flag = legendary_leader
                }
            }
            change_species = event_target:target_species
            change_leader_portrait = species
            add_trait = leader_trait_synthetic
            change_background_ethic = ethic_gestalt_consciousness
        }
        every_pool_leader = {
            change_species = event_target:target_species
            change_leader_portrait = species
            add_trait = leader_trait_synthetic
            change_background_ethic = ethic_gestalt_consciousness
        }
        every_envoy = {
            change_species = event_target:target_species
            change_leader_portrait = species
            add_trait = leader_trait_synthetic
            change_background_ethic = ethic_gestalt_consciousness
        }

        # Sort out your new leadership council
        country_event = { id = game_start.70 }

        # Give them the average skill of our previous council
        every_owned_leader = {
            limit = {
                is_councilor = yes
                is_ruler = no
            }
            set_skill = 1
            add_skill_without_trait_selection = prev.council_level
            set_gestalt_node_protrait_effect = yes
        }

        # Make Condan our ruler
        condan_switch_to_ruler = yes
        ruler = {
            kill_leader = { show_notification = no }
        }
        set_leader = condan_ruler
        event_target:condan_leader = {
            condan_set_ruler_councilor_traits = yes
        }

        # Armies
        every_owned_army = {
            limit = { is_defensive_army = yes }
            modify_army = {
                type = machine_defense
                species = event_target:target_species
            }
        }
        every_owned_army = {
            limit = { is_defensive_army = no }
            modify_army = {
                type = machine_assault_1
                species = event_target:target_species
            }
        }

        # Diplomacy
        # I would like to think that force booting you from the galactic community would also unset emperor and custodian
        # But I don't want to leave the game in a wierd state for the cost of a few if statements
        if = {
            limit = { is_galactic_emperor = yes }
            set_galactic_emperor = no
        }
        if = {
            limit = { is_galactic_custodian = yes }
            set_galactic_custodian = no
        }
        if = {
            limit = { is_part_of_galactic_council = yes }
            remove_from_galactic_council = yes
        }
        if = {
            limit = { is_galactic_community_member = yes }
            remove_from_galactic_community = yes
        }

        # If you are in a non-machine federation, got to go.
        if = {
            limit = { any_federation_ally = { NOT = { has_authority = auth_machine_intelligence} } }
            remove_from_federation = yes
        }

        #enclaves
        remove_modifier = enclave_artist_patron
        remove_modifier = curator_insight
        remove_modifier = salvager_insight
        remove_modifier = salvager_overdrive
        remove_modifier = mercenary_enclave_logistic_help

        remove_xuracorp_trades = yes
        remove_riggan_trades = yes
        remove_muutagan_trades = yes

        every_owned_fleet = {
            limit = { is_leased = yes }
            end_fleet_contract = {
                initiator = root
                reason = cancelled
            }
        }

        # Remove enclave leaders
        #every_owned_leader = {
        #    limit = {
        #
        #    }
        #}

        # TODO Mercenary fleets and soldiers

        # Alas I can't directly interact with your diplomatic pacts to force break them all.  Have to let the AI do that themselves

        # So the pulse happens at end of month that does all the economic switch over, but we want to do a chunk now to stop things looking really strange
        every_owned_planet = {
            remove_modifier = slave_colony
            remove_modifier = resort_colony
            remove_modifier = penal_colony
            validate_and_repair_planet_buildings_and_districts = yes
            every_owned_pop = {
                unemploy_pop = yes
                clear_pop_category = yes
            }
            check_planet_employment = yes
        }

        country_event = { id = condan_comms.041 }
    }
}


# Background event that increases cores power
country_event = {
    id = condan_events.040
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_global_flag = condan_recruited
        has_country_flag = condan_owner
    }

    immediate = {
        if = {
            limit = {
                NOT = { has_country_flag = condan_unhappy } # once unhappy, its not going to happy again
                OR = {
                    condan_has_other_ascension_path = yes
                    has_crisis_level = crisis_level_4
                }
            }
            log = "Condan is unhappy.  COMMENCE REBELLION!"
            event_target:condan_country = { set_country_flag = condan_unhappy}
        }
        if = {
            limit = {
                is_gestalt = no # performance improvement, no councils in gestalts.
                any_council_member = { is_same_value = event_target:condan_leader }
            }
            log = "Condan is on the council, UNLIMITED POWER"
            event_target:condan_country = { change_variable = { which = condan_power value = 5 } }
        }
        else = {
            event_target:condan_country = { change_variable = { which = condan_power value = 1 } }
        }
    }
}